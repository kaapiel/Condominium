# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  unity: game-ci/unity@1.3.0

jobs:
  run-command:
    resource_class: 'windows.medium'
    machine:
      image: unityci/editor:windows-2022.1.23f1-universal-windows-platform-1.0.1
    steps:
      #- checkout
      - unity/prepare-env
      #- run:
      #    name: "mkdir"
      #    command: |
      #      cp Assets/Resources/Scripts/Editor/CustomUnityCli.cs ./CustomUnityCli.cs
      #      rm -r Assets
      #      mkdir -p Assets/Scripts/Editor
      #      cp ./CustomUnityCli.cs ./Assets/Scripts/Editor/CustomUnityCli.cs
      #      mkdir -p Assets/StreamingAssets
      #- run:
      #    name: "Download skp file"
      #    command: |
      #      export SKP_FILE_NAME=$(curl -s 'https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/' | jq '.items[0].name' | tr -d '"')
      #      export SKP_FILE_TOKEN=$(curl -s "https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/${SKP_FILE_NAME}" | jq '.downloadTokens' | tr -d '"')
      #      echo "https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/${SKP_FILE_NAME}?alt=media&token=${SKP_FILE_TOKEN}"
      #      echo "export FILE_NAME=$SKP_FILE_NAME" >> $BASH_ENV
      #      curl -o "./Assets/$SKP_FILE_NAME" "https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/${SKP_FILE_NAME}?alt=media&token=${SKP_FILE_TOKEN}"
      #      echo ""
      #- run:
      #    name: "Build Asset Bundles"
      #    command: |
      #      /Applications/Unity/Hub/Editor/2021.3.14f1/Unity.app/Contents/MacOS/Unity -projectPath . -quit -batchmode -nographics -username "$UNITY_USERNAME" -password "$UNITY_PASSWORD" -serial "$RESOLVED_UNITY_SERIAL" -stackTraceLogType Full -executeMethod CustomUnityCli.BuildAssetBundles -logFile /dev/stdout "$FILE_NAME"
      #      echo ""
      #      ls ./Assets/StreamingAssets
      #- store_artifacts:
      #    path: ./Assets/StreamingAssets

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  generate-asset-bundle-workflow:
      jobs:
        #- unity/create-activation-file:
        #    editor_version: '2021.3.1f1'
        - run-command