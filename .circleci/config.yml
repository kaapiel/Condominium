# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  unity: game-ci/unity@1.3.0

jobs:
  run-command:
    #docker:
    #  - image: unityci/editor:ubuntu-2021.3.14f1-ios-1.0.1
    macos:
      xcode: 14.1.0
    steps:
      #- checkout
      #- unity/prepare-env
      - run:
          name: "Install Unity Hub"
          command: |
            brew install --cask unity-hub
      - run:
          name: "Install Unity Editor"
          command: |
            '/Applications/Unity Hub.app/Contents/MacOS/Unity Hub' -- --headless install --version '2021.3.14f1' --changeset 'eee1884e7226' --module ios --childModules && echo "Unity Editor Installed"
            echo "Unity Editor Installed"
      - run:
          name: "Resolve Unity Serial"
          command: |
            readonly unity_license_file_path="/Library/Application Support/Unity"
            sudo mkdir -p "$unity_license_file_path"
            sudo chmod -R 777 "$unity_license_file_path"
            export LC_CTYPE=en_US.UTF-8
            export LC_ALL=en_US.UTF-8 
            local unity_license
            local developer_data
            local encoded_serial
            unity_license="$(base64 --decode \<<< "$unity_encoded_license")"
            developer_data="$(perl -nle 'print $& while m{<DeveloperData Value\="\K.*?(?="/>)}g' \<<< "$unity_license")"
            encoded_serial="$(cut -c 5- \<<< "$developer_data")"
            decoded_unity_serial="$(base64 --decode \<<< "$encoded_serial")"
            readonly decoded_unity_serial
            /Applications/Unity/Hub/Editor/2021.3.14f1/Unity.app/Contents/MacOS/Unity -batchmode -quit -nographics -username "$unity_username" -password "$unity_password" -serial "$resolved_unity_serial" -logfile /dev/stdout
      - run:
          name: "mkdir"
          command: |
            cp Assets/Resources/Scripts/Editor/CustomUnityCli.cs ./CustomUnityCli.cs
            rm -r Assets
            mkdir -p Assets/Scripts/Editor
            cp ./CustomUnityCli.cs ./Assets/Scripts/Editor/CustomUnityCli.cs
            mkdir -p Assets/StreamingAssets
      - run:
          name: "Download skp file"
          command: |
            export SKP_FILE_NAME=$(curl -s 'https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/' | jq '.items[0].name' | tr -d '"')
            export SKP_FILE_TOKEN=$(curl -s "https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/${SKP_FILE_NAME}" | jq '.downloadTokens' | tr -d '"')
            echo "https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/${SKP_FILE_NAME}?alt=media&token=${SKP_FILE_TOKEN}"
            echo "export FILE_NAME=$SKP_FILE_NAME" >> $BASH_ENV
            curl -o "./Assets/$SKP_FILE_NAME" "https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/${SKP_FILE_NAME}?alt=media&token=${SKP_FILE_TOKEN}"
            echo ""
      - run:
          name: "Build Asset Bundles"
          command: |
            /Applications/Unity/Hub/Editor/2021.3.14f1/Unity.app/Contents/MacOS/Unity -projectPath . -quit -batchmode -nographics -username "$UNITY_USERNAME" -password "$UNITY_PASSWORD" -serial "$resolved_unity_serial" -stackTraceLogType Full -executeMethod CustomUnityCli.BuildAssetBundles -logFile /dev/stdout "$FILE_NAME"
            echo ""
            ls ./Assets/StreamingAssets
      - store_artifacts:
          path: ./Assets/StreamingAssets

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  generate-asset-bundle-workflow:
      jobs:
        #- unity/create-activation-file:
        #    editor_version: '2021.3.1f1'
        - run-command