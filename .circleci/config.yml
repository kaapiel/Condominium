# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  unity: game-ci/unity@1.3.0
  #win: circleci/windows@4.1.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  working_directory: /tmp
  build-asset-bundles:
    #executor: win/default
    #macos:
    #  xcode: 14.1.0
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Dirs
          command: ls
      #- run:
      #    name: "Download skp file"
      #    command: |
      #      export SKP_FILE_NAME=$(curl -s 'https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/' | jq '.items[0].name' | tr -d '"')
      #      export SKP_FILE_TOKEN=$(curl -s "https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/${SKP_FILE_NAME}" | jq '.downloadTokens' | tr -d '"')
      #      echo "https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/${SKP_FILE_NAME}?alt=media&token=${SKP_FILE_TOKEN}"
      #      curl -o "/tmp/$SKP_FILE_NAME" "https://firebasestorage.googleapis.com/v0/b/condominium-unity.appspot.com/o/${SKP_FILE_NAME}?alt=media&token=${SKP_FILE_TOKEN}"
      - store_artifacts:
          path: /tmp
      #- run:
      #    name: Install XVFB
      #    command: sudo apt-get install xvfb
      #- run:
      #    name: Install unity-hub
      #    command: brew install --cask unity-hub
      #- run:    
      #    name: Install Unity
      #    command: |
      #      '/Applications/Unity Hub.app/Contents/MacOS/Unity Hub' -- --headless install --version 2021.3.1f1 --changeset 3b70a0754835 --module mac-il2cpp --childModules && echo "Unity Installed"
      #      echo "Unity Installed"
      #- unity/build:
      #    build-target: iOS
      #    step-name: Build Asset Bundle 
      #    build-method: CustomUnityCli.BuildAssetBundles
      #    custom-parameters: FILE_NAME.skp
      #    project-path: ./
      #- run:
      #    name: b
      #    command: |
      #      /Applications/Unity/Hub/Editor/2021.3.1f1/Unity.app/Contents/MacOS/Unity -batchmode -projectPath /Users/distiller/project/. -executeMethod CustomUnityCli.BuildAssetBundles FILE_NAME.skp -quit -logFile /dev/stdout
      - run:
          name: "Upload Asset Bundles"
          command: "echo Upload Asset Bundles"
      - run:
          name: "Delete skp file from cloud"
          command: "echo Delete skp file from cloud"
      - run:
          name: "Save Asset Bundle artifact"
          command: "echo Save Asset Bundle artifact"


# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  generate-asset-bundle-workflow:
      jobs:
        - unity/create-activation-file:
            name: "create-activation-file"
            
        - build-asset-bundles
        - unity/build:
            name: "Build Asset Bundles"
            build-target: StandaloneLinux64
            build-method: CustomUnityCli.BuildAssetBundles
            custom-parameters: GE23_test.skp
            compress: false
            context: cpe-unity
            project-path: .
            executor:
              name: unity/ubuntu
              target_platform: "linux-il2cpp"
              editor_version: 2021.3.1f1
              resource_class: medium
            unity-license-var-name: UNITY_ENCODED_LICENSE 
            unity-password-var-name: UNITY_PASSWORD 
            unity-username-var-name: UNITY_USERNAME 